# 要件定義書

## はじめに

Conversation EngineはGemini APIベースのLLM対話エンジンです。ユーザーのエイムトレーニングスコアと過去の会話履歴を考慮し、パーソナライズされたコーチング対話を生成します。主にdiscord-bot-interfaceから呼び出され、FPSプレイヤーに対して自然な日本語での技術指導とアドバイスを提供します。

## 要件

### 要件1: 自然言語対話生成
**目的:** FPSプレイヤーとして、AIコーチと自然な日本語で対話したい。専門的なアドバイスを理解しやすい形で受け取りたい。

#### 受入基準

1. ユーザーから質問やコメントを受信した場合、Conversation Engineは文脈に適した自然な日本語で応答を生成する
2. エイムトレーニングに関する専門用語を使用する場合、Conversation Engineは初心者にも理解できる説明を含める
3. ユーザーの技術レベルに応じて、Conversation Engineは適切な難易度の説明とアドバイスを提供する
4. 励ましやモチベーション向上が必要な場合、Conversation Engineは前向きで建設的なメッセージを生成する
5. 不適切な内容や攻撃的な発言に対して、Conversation Engineは適切にフィルタリングし、建設的な対話に導く

### 要件2: スコアデータ統合と分析的対話
**目的:** システムコンポーネントとして、ユーザーのエイムスコアデータを活用した具体的なアドバイスを生成したい。データに基づいた客観的な指導を提供したい。

#### 受入基準

1. エイムスコアデータを受信した場合、Conversation Engineはスコアの傾向と改善点を分析し、具体的なフィードバックを生成する
2. スコアの向上が見られる場合、Conversation Engineは成果を認めて次のレベルへの挑戦を提案する
3. スコアの低下や停滞が見られる場合、Conversation Engineは原因を推測し、改善のためのトレーニング方法を提案する
4. 複数のスコアデータを比較する場合、Conversation Engineは相対的な強み・弱みを特定し、優先すべき練習領域を示す
5. スコアデータが不足している場合、Conversation Engineはデータ収集の重要性を説明し、記録方法を案内する
6. 会話の流れでスコア分析が必要な場合、Conversation Engineはanalytics-engineを呼び出して専門的な分析結果を取得する
7. analytics-engineから分析結果を受信した場合、Conversation Engineは会話の文脈に適した形で結果をユーザーに説明する

### 要件3: 会話履歴とコンテキスト管理
**目的:** FPSプレイヤーとして、過去の対話を踏まえた継続的なコーチングを受けたい。以前の相談内容や進捗を覚えていてほしい。

#### 受入基準

1. 過去の会話履歴を受信した場合、Conversation Engineは前回の話題や提案した練習方法を参照して継続的な対話を行う
2. ユーザーが以前設定した目標について質問された場合、Conversation Engineは目標の進捗状況を確認し、必要に応じて調整を提案する
3. 繰り返される質問や悩みがある場合、Conversation Engineはパターンを認識し、根本的な解決策を提案する
4. 長期間の対話履歴がある場合、Conversation Engineはユーザーの成長過程を評価し、長期的な視点でのアドバイスを提供する
5. 会話のトーンや関係性の変化を認識し、Conversation Engineはユーザーとの関係に適した対話スタイルを維持する

### 要件4: Gemini API統合とLLM機能
**目的:** システムコンポーネントとして、Gemini APIを活用した高品質な対話生成機能を提供したい。API制約内で安定した性能を維持したい。

#### 受入基準

1. Gemini APIにリクエストを送信する場合、Conversation Engineは適切なプロンプト構造とパラメータを使用して高品質な応答を生成する
2. APIレスポンス時間が長い場合、Conversation Engineは適切なタイムアウト管理を行い、必要に応じて降格した応答を提供する
3. API使用量が制限に近づいた場合、Conversation Engineはリクエストを最適化し、重要度に応じて処理を調整する
4. APIエラーが発生した場合、Conversation Engineは適切なリトライ機構を実行し、失敗時は代替応答を提供する
5. プロンプトインジェクション攻撃を検知した場合、Conversation Engineは入力をサニタイズし、セキュリティイベントをログに記録する

### 要件5: Discord Bot Interface連携
**目的:** システムコンポーネントとして、discord-bot-interfaceとシームレスに連携し、一貫したユーザー体験を提供したい。

#### 受入基準

1. discord-bot-interfaceからリクエストを受信した場合、Conversation Engineは標準的なAPI形式で対話内容を返す
2. Discord の文字制限を考慮し、Conversation Engineは適切な長さの応答を生成する（長い場合は分割提案）
3. Discord の書式設定（マークダウン等）を活用し、Conversation Engineは読みやすい形式で応答をフォーマットする
4. スラッシュコマンドの文脈を理解し、Conversation Engineはコマンドに適した応答スタイルを採用する
5. メンション形式の自然な対話では、Conversation Engineはより親近感のある対話スタイルで応答する

### 要件6: パーソナライゼーションと学習
**目的:** FPSプレイヤーとして、自分のプレイスタイルや好みに合わせたカスタマイズされたアドバイスを受けたい。

#### 受入基準

1. ユーザーの好みのゲームタイトルやジャンルを把握した場合、Conversation Engineはそれに特化したアドバイスを提供する
2. ユーザーの練習頻度や時間帯のパターンを認識し、Conversation Engineは実現可能な練習計画を提案する
3. ユーザーの質問傾向や興味領域を学習し、Conversation Engineは関連する情報を先行的に提供する
4. ユーザーのフィードバックや反応を分析し、Conversation Engineは対話スタイルを調整する
5. 複数のユーザーの傾向を学習しても、Conversation Engineは個人のプライバシーを保護し、個別の情報を混同しない

### 要件7: エラーハンドリングと品質保証
**目的:** システムの信頼性を確保し、ユーザーに一貫した高品質な体験を提供したい。

#### 受入基準

1. 不正な入力データを受信した場合、Conversation Engineは適切なバリデーションを行い、エラーの詳細をログに記録する
2. 生成された応答が不適切な内容を含む場合、Conversation Engineは内容をフィルタリングし、代替応答を提供する
3. システム負荷が高い場合、Conversation Engineは応答品質を維持しつつ、処理時間を最適化する
4. データ整合性の問題を検知した場合、Conversation Engineは安全な代替動作を実行し、管理者に通知する
5. 予期しないエラーが発生した場合、Conversation Engineは適切なエラーメッセージを返し、システムの安定性を維持する

### 要件8: パフォーマンスとスケーラビリティ
**目的:** Cloudflare Workers環境で効率的に動作し、多数のユーザーに対して安定したサービスを提供したい。

#### 受入基準

1. 対話生成リクエストを処理する場合、Conversation Engineは30秒のWorkers制限内で応答を生成する
2. 通常の対話では、Conversation Engineは10秒以内で応答を生成し、ユーザーの待機時間を最小化する
3. メモリ使用量が制限に近づいた場合、Conversation Engineは不要なデータを適切にクリアし、メモリリークを防ぐ
4. 同時リクエストが増加した場合、Conversation Engineは適切にリクエストをキューイングし、順次処理する
5. キャッシュ可能な応答については、Conversation Engineは適切なキャッシュ戦略を実装し、レスポンス時間を向上させる